<!--
layout: default
-->
<h1>Block: {{ name }}</h1>
<svg width="1000px" height="600px">
    <style type="text/css">
        text {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .block-square {
            stroke: black;
            fill: white;
            filter: drop-shadow(0 3px 5px rgba(0,0,0,0.3));
        }
        .dot {
            stroke: black;
            fill: black;
        }
        .block-input-dot.external-dot, .block-output-dot.dot-on-box {
            fill: white;
        }
        path {
            stroke: black;
        }
        path.block-input-path, path.block-output-path {
            fill: transparent;
        }
        rect.output-field {
            stroke-dasharray: 5;
        }
    </style>
    <g id="renderspace"></g>
</svg>

<!-- modals -->
<style type="text/css">
    .modal {
        display: none;
        position: fixed;
        top: calc(50% - 140px);
        left: calc(50% - 300px);
        right: calc(50% - 300px);
        bottom: calc(50% - 140px);
        z-index: 100;
        background: white;
        padding: 15px;
        font-size: 0.9em;
    }
    .modal-close:after {
        content: '[close]';
    }
    .modal-close {
        color: rgba(0,0,0,0.7);
        float: right;
        padding: 8px;
        cursor: pointer;
    }
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.2);
        filter: blur(10px);
    }
    .modal input {
        width: 400px;
    }
</style>
<div class="modal-container">
    <div class="modal-overlay"></div>
    <div class="modal edit-field-modal">
        <div class="modal-close"></div>
        <h1>Edit value: <span class="value-name"></h1>
        <table>
            <tr>
                <td>String</td>
                <td><input type="text" class="str-value"></td>
            </tr>
            <tr>
                <td>Hex</td>
                <td><input type="text" class="hex-value"></td>
            </tr>
            <tr>
                <td>Int array (buffer)</td>
                <td><input type="text" class="int-value"></td>
            </tr>
            <tr>
                <td>Bits (binary string)</td>
                <td><input type="text" class="bit-value"></td>
            </tr>
        </table>
    </div>
    <div class="modal inspect-field-modal">
        <div class="modal-close"></div>
        <h1>Inspect value: <span class="value-name"></h1>
        <table>
            <tr>
                <td>String</td>
                <td class="str-value"></td>
            </tr>
            <tr>
                <td>Hex</td>
                <td class="hex-value"></td>
            </tr>
            <tr>
                <td>Int array (buffer)</td>
                <td class="int-value"></td>
            </tr>
            <tr>
                <td>Bits (binary string)</td>
                <td class="bit-value"></td>
            </tr>
        </table>
    </div>
</div>
<script>
    let overlay = document.querySelector(".modal-overlay");
    let modals = document.querySelectorAll(".modal");
    Array.prototype.forEach.call(modals, (modal) => {
        modal.querySelector(".modal-close").addEventListener("click", (e) => {
            modal.style = "";
            overlay.style = "";
        });
    });

    //TODO: generate all representations from int array
    let inspectFieldModal = document.querySelector(".inspect-field-modal");
    let inspectField = (data) => {
        let set = (key, val) => inspectFieldModal.querySelector(key).innerText = val;
        set(".value-name", data.name);
        set(".str-value", cryptoflow.encode("buf", "string", data.value));
        set(".hex-value", cryptoflow.encode("buf", "hex", data.value));
        set(".int-value", data.value.join(" "));
        set(".bit-value", cryptoflow.encode("buf", "bits", data.value));
        inspectFieldModal.style = "display: block;";
        overlay.style = "display: block;";
    }

    let updateOnChange = (inputName, inputField, from) => {
        return (e) => {
            let set = (key, val) => editFieldModal.querySelector(key).value = val;

            let value = inputField.value;
            if(from == "buf") value = value.split(" ").map(s => parseInt(s));

            if(from != "string") set(".str-value", cryptoflow.encode(from, "string", value));
            if(from != "buf") set(".int-value", cryptoflow.encode(from, "buf", value).join(" "));
            if(from != "bits") set(".bit-value", cryptoflow.encode(from, "bits", value));
            if(from != "hex") {
                let hexValue = cryptoflow.encode(from, "hex", value);
                set(".hex-value", hexValue);
                block.setValue(inputName, hexValue);
            }
            else {
                block.setValue(inputName, value);
            }
        };
    };

    let updateFunctions = [];
    let setUpUpdateOnChange = (inputName) => {
        console.log("setting up listeners for", inputName);
        let setListener = (selector, from) => {
            let inputField = document.querySelector(`input${selector}`);
            let listener = updateOnChange(inputName, inputField, from);
            inputField.addEventListener("change", listener);
            updateFunctions.push({ inputField, listener });
        }
        setListener(".str-value", "string");
        setListener(".hex-value", "hex");
        setListener(".int-value", "buf");
        setListener(".bit-value", "bits");
        console.log("set up listeners for", inputName, updateFunctions);
    };
    let clearUpdateOnChange = () => {
        updateFunctions.forEach(({ inputField, listener }) => inputField.removeEventListener("change", listener));
        updateFunctions = [];
    };

    let editFieldModal = document.querySelector(".edit-field-modal");
    let editField = (data) => {
        let set = (key, val) => editFieldModal.querySelector(key).value = val;
        set(".value-name", data.name);
        set(".str-value", cryptoflow.encode("buf", "string", data.value));
        set(".hex-value", cryptoflow.encode("buf", "hex", data.value));
        set(".int-value", data.value.join(" "));
        set(".bit-value", cryptoflow.encode("buf", "bits", data.value));

        setUpUpdateOnChange(data.name);
        editFieldModal.style = "display: block;";
        overlay.style = "display: block;";

        let modalClose = editFieldModal.querySelector(".modal-close");
        modalClose.addEventListener("click", closeListener);

        function closeListener(e) {
            clearUpdateOnChange();
            modalClose.removeEventListener("click", closeListener);
        }
    }

    //TODO: Click on block: display the block's inputs and outputs on top of each other
    //      (pick an encoding, so eg. xor could show bits over bits over bits to give intuition).
    //      (make them editable to see live results)

    //TODO: Encoding: add option to view as a large integer (bigint), one long base 10 value.
</script>

<!-- script -->
<script>
    let block = cryptoflow.blocks["{{ id }}"];

    let renderspace = d3.select("#renderspace");
    block.render(renderspace, inspectField, editField);
</script>
